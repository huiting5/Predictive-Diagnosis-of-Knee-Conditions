---
output:
  pdf_document:
    keep_tex: true
header-includes:
  - \usepackage{graphicx}
  - \usepackage{booktabs}
---

\begin{titlepage}
    \centering
    \vspace*{6cm}
    {\Huge \bfseries Predictive Diagnosis of Knee Conditions \par}
    \vskip 2cm
    {\Large Huiting Wu \par}
    {\Large Sharmeen Kapoorwala \par}
    \vskip 2cm
    {\large \today \par}
    \vfill
\end{titlepage}

\newpage

```{r message=FALSE, warning = FALSE, include=FALSE}
library(stringr)
library(readxl)
library(visdat)
library(dplyr)
library(car)
library(GGally)
library(rpart)
library(caret)
library(pROC)
library(rpart.plot) 
library(ggplot2)
library(knitr)
library(rsample)
library(vip)
library(RColorBrewer)
```

```{r message=FALSE, warning = FALSE, include=FALSE}
knee <- read_excel("Osteoporosis Knee X-ray/patient details.xlsx")
knee <- knee[1:(nrow(knee) - 3), ]
head(knee)
nrow(knee)
knee <- knee |> mutate(across(where(is.character), as.factor))

mwd_median <- median(knee$`Maximum Walking distance (km)`, na.rm = T)
knee <- knee |> mutate(
  MWD = ifelse(is.na(`Maximum Walking distance (km)`), mwd_median,
               `Maximum Walking distance (km)`)
) |> select(-`Maximum Walking distance (km)`)

knee$Menopause_Age <- as.numeric(knee$`Menopause Age`)
knee <- knee |> select(-`Menopause Age`)

female_median <- median(knee$Menopause_Age[knee$Gender == "female"], na.rm = TRUE)

knee <- knee  |> 
  mutate(Menopause_Age = case_when(
    Gender == "female" & is.na(Menopause_Age) ~ female_median,
    Gender == "male" & is.na(Menopause_Age) ~ NA_real_,  # keep as NA
    TRUE ~ Menopause_Age
  ))

female_mean <- mean(knee$`Number of Pregnancies`[knee$Gender == "female"], 
                    na.rm = TRUE)

knee <- knee  |> 
  mutate(pregnancies = case_when(
    Gender == "female" & is.na(`Number of Pregnancies`) ~ female_mean,
    Gender == "male" & is.na(`Number of Pregnancies`) ~ 0,  # keep as NA
    TRUE ~ `Number of Pregnancies`
  )) |> 
  select(-`Number of Pregnancies`)

occupation_corrections <- c(
  "h.wife" = "housewife"
)

knee <- knee |> 
  mutate(
     # lowercase and trim
    career_clean = tolower(trimws(Occupation)),
    
    # replace the names
    career_clean = str_replace_all(career_clean, occupation_corrections),
    
    # the missing value as "unknown"
    career_clean = ifelse(is.na(career_clean), "unknown", career_clean),
    
    # organize it more
    career = case_when(career_clean == "housewife" ~ "housewife",
      TRUE ~ "others"
    )
  ) |> select(-career_clean, -Occupation)

knee <- knee |> 
  mutate(
    eating_clean = tolower(trimws(`Daily Eating habits`)),
    eating_habit = ifelse(
      eating_clean == "normal", "normal", "limited"
    )
  ) |>
  select(-eating_clean, -`Daily Eating habits`)

knee <- knee |> mutate(
  obesity = ifelse(Obesity == "overweight", "over weight", Obesity)
) |> select(-Obesity)

knee <- knee |> 
  mutate(
    injury_type = `History of Fracture`,
    # Clean up and categorize injuries into main parts
    injury_part = case_when(
      str_detect(injury_type, "leg") ~ "leg",
      str_detect(injury_type, "foot") ~ "foot",
      str_detect(injury_type, "arm") ~ "arm",
      str_detect(injury_type, "wrist") ~ "wrist",
      str_detect(injury_type, "shoulder") ~ "shoulder",
      str_detect(injury_type, "hip") ~ "hip",
      str_detect(injury_type, "no") ~ "no injury",
      str_detect(injury_type, "knee") ~ "knee",
      str_detect(injury_type, "head") ~ "head",
      str_detect(injury_type, "neck") ~ "neck",
      TRUE ~ "Other"
    ),
    
    # Categorizing into lower body, upper body, and fractures
    injury = case_when(
      injury_part %in% c("leg", "foot", "hip", "knee") ~ "Lower Body",
      injury_part %in% c("arm", "wrist", "shoulder", "head", "neck") ~ "Upper Body",
      injury_part == "Other" ~ "Other",
      injury_part == "no injury" ~ "no injury",
      TRUE ~ "Fractures"
    )
  ) |> select(-injury_type, -injury_part, -`History of Fracture`)

knee <- knee |> mutate(
  medical_hist = ifelse(`Medical History` %in% c("no", "normal"), "no", "yes")
) |> select(-`Medical History`)

knee <- knee |> mutate(across(where(is.character), as.factor)) |> 
  select(-`Patient Id`, -Alcoholic, -Site, -S.No) |> 
  rename(BMI = `BMI:`,
         dialysis = `Dialysis:`,
         joint_pain = `Joint Pain:`)

knee_clean <- knee |> mutate(
  dummy_diagnosis = ifelse(Diagnosis == "normal", 0, 1),
  dummy_diagnosis = as.factor(dummy_diagnosis),
)
```

```{r message=FALSE, warning = FALSE, include=FALSE}
knee_model <- knee_clean |> 
  select(-Diagnosis, -Menopause_Age, -dialysis, 
         -`T-score Value`, -`Z-Score Value`, -obesity) |> na.omit()

full <- glm(dummy_diagnosis ~ ., data = knee_model, family = binomial)
summary(full)

null <- glm(dummy_diagnosis ~ 1, data = knee_model, family = binomial)

select_aic <- glm(dummy_diagnosis ~ Age + `Weight (KG)` + Diabetic + 
    BMI + pregnancies + career + medical_hist, family = binomial, 
    data = knee_model)

select_bic <- glm(dummy_diagnosis ~ Age + pregnancies, family = binomial, 
    data = knee_model)
```


```{r message=FALSE, warning = FALSE, include=FALSE}
# BIC model
set.seed(333)
n <- nrow(knee_model)
floor(0.7*n)

# split into training data and testing data
train <- sample(1:n, 166)

# fit the model with training data
glm_train <- glm(dummy_diagnosis ~ Age + pregnancies, family = binomial, 
    data = knee_model, subset = train)

# test set
test <- knee_model[-train, ]

# prediction on test set
pred_prob <- predict(glm_train, newdata = test, type = "response")
class_preds <- rep(0, 72)
class_preds[pred_prob > 0.5] <- 1
```

```{r message=FALSE, warning = FALSE, include=FALSE}
# fit the model with training data
glm_train1 <- glm(dummy_diagnosis ~ Age + `Weight (KG)` + Diabetic + 
    BMI + pregnancies + career + medical_hist, family = binomial, 
    data = knee_model)

# test set
test <- knee_model[-train, ]

# prediction on test set
pred_prob1 <- predict(glm_train1, newdata = test, type = "response")

class_preds1 <- rep(0, 72)
class_preds1[pred_prob1 > 0.5] <- 1
```


```{r message=FALSE, warning = FALSE, include=FALSE}
# Decision Tree
# Split data into training and testing sets
set.seed(333)

data_split <- knee_model |> initial_split(prop = 0.7)
train_data <- data_split |> training()
test_data <- data_split |> testing()

# Fit the Decision Tree Model
tree_model <- rpart(dummy_diagnosis ~ ., data = train_data, method = "class")

# Predict on the test set
tree_pred <- predict(tree_model, test_data, type = "class")
tree_pred_prob <- predict(tree_model, test_data, type = "prob")
```

# Introduction

From: https://data.mendeley.com/datasets/fxjm8fb6mw/2

# Data Description

```{r message=FALSE, fig.width=18, fig.height=10, echo=FALSE}
ggpairs(
  knee |> select(Diagnosis, where(is.numeric), -Menopause_Age),
  aes(color = Diagnosis),
  upper = list(continuous = wrap("cor", size = 4)), 
  lower = list(continuous = wrap("points", alpha = 0.6)),
  diag = list(continuous = wrap("densityDiag", alpha = 0.5)),
  legend = 1
) + 
  scale_color_brewer(palette = "Set2") +
  theme_minimal()
```

```{r message=FALSE, warning = FALSE, echo=FALSE, fig.width= 5, fig.height=3}
knee_clean |> group_by(Diagnosis) |> 
  ggplot(aes(x = Diagnosis, fill = Gender)) +
  geom_bar(position = "dodge", col = "black") +
  labs(title = "Diagnosis Distribution among male 
       and female patients",
       y = "Frequency") + 
  geom_text(stat = "count", aes(label = ..count..), 
            position = position_dodge(width = 0.9), 
            vjust = -0.3, size = 3) +
  scale_fill_brewer(palette = "Set2") +
  theme_classic() +
  theme(
    plot.title = element_text(size =8, face = "bold"),
    axis.title = element_text(size = 7),
    axis.text = element_text(size = 7),
    legend.text = element_text(size = 7),
    legend.title = element_text(size = 7)
  )
```

# Methods and Results

**Confusion Matrix**

```{r results='asis', echo=FALSE, message=FALSE, warning=FALSE}

# Confusion matrices
cm_aic <- addmargins(table(prediction = class_preds1, actual = test$dummy_diagnosis))
cm_bic <- addmargins(table(prediction = class_preds, actual = test$dummy_diagnosis))
cm_tree <- addmargins(table(test_data$dummy_diagnosis, tree_pred))

# Generate LaTeX tables (no float)
k1 <- kable(cm_aic, format = "latex", booktabs = TRUE, table.envir = NULL)
k2 <- kable(cm_bic, format = "latex", booktabs = TRUE, table.envir = NULL)
k3 <- kable(cm_tree, format = "latex", booktabs = TRUE, table.envir = NULL)

# Print LaTeX minipages with properly wrapped scalebox
cat(knitr::asis_output(paste0(
"\\noindent
\\begin{minipage}{0.32\\linewidth}
\\centering
\\textbf{Confusion Matrix (AIC)}\\\\
\\scalebox{0.75}{\\begin{tabular}{", paste(rep("r", ncol(cm_aic) + 1), collapse = ""), "}
\\toprule
 & ", paste0(colnames(cm_aic), collapse = " & "), " \\\\
\\midrule
", paste(apply(cbind(rownames(cm_aic), cm_aic), 1, function(row) paste(row, collapse = " & ")), collapse = " \\\\\n"), " \\\\
\\bottomrule
\\end{tabular}}
\\end{minipage}
\\hfill
\\begin{minipage}{0.32\\linewidth}
\\centering
\\textbf{Confusion Matrix (BIC)}\\\\
\\scalebox{0.75}{", k2, "}
\\end{minipage}
\\hfill
\\begin{minipage}{0.32\\linewidth}
\\centering
\\textbf{Confusion Matrix (Decision Tree)}\\\\
\\scalebox{0.75}{", k3, "}
\\end{minipage}"
)))

```

**ROC Curves**

```{r message=FALSE, warning = FALSE, echo=FALSE, fig.width=3.5, fig.height=3.5}
colors <- brewer.pal(3, "Set2")

# ROC curves
roc_aic <- roc(test$dummy_diagnosis, pred_prob1)
roc_bic <- roc(test$dummy_diagnosis, pred_prob)
roc_tree <- roc(test_data$dummy_diagnosis, tree_pred_prob[,2])

# Plot with different line types and Set2 colors
par(cex.main = 1,     
    cex.lab = 0.8,      
    cex.axis = 0.8,     
    mar = c(5, 5, 4, 2)
)
plot(roc_aic, main = "ROC Curves Comparison", col = colors[1], lwd = 3, lty = 1)
lines(roc_bic, col = colors[2], lwd = 3, lty = 2)
lines(roc_tree, col = colors[3], lwd = 3, lty = 3)

# Add legend
legend("bottomright",
       legend = c("AIC Model", "BIC Model", "Decision Tree"),
       col = colors,
       lwd = 2,
       lty = c(1, 2, 3),
       cex = 0.8)
```

**Decision Tree** **Variable Important**

```{r message=FALSE, warning = FALSE, echo=FALSE, eval=FALSE}
# Save decision tree (base R plot)
png("tree_plot.png", width = 1600, height = 1200, res = 150)
rpart.plot(tree_model, type = 3, main = "Decision Tree", digits = 1,
           cex = 1.8, box.palette = "GnBu", shadow.col = "gray")
dev.off()

# Save variable importance (ggplot)
vip_plot <- vip(tree_model) +
  geom_col(fill = "khaki", col = "black") +
  theme_minimal() +
  labs(title = "Important Variables in Decision Tree Model") +
  theme(
    plot.title = element_text(size = 16, face = "bold", color = "black"),
    axis.title = element_text(size = 14, color = "black"),
    axis.text = element_text(size = 13, color = "black"),
    axis.ticks = element_line(color = "black"),
    panel.grid.major = element_line(color = "grey80"),
    panel.grid.minor = element_blank()
  )

ggsave("vip_plot.png", vip_plot, width = 10, height = 8, dpi = 300)
```

\begin{figure}[htbp]
\centering
\includegraphics[width=0.48\textwidth]{tree_plot.png}
\hfill
\includegraphics[width=0.48\textwidth]{vip_plot.png}
\caption{Decision Tree (left) and Variable Importance (right)}
\end{figure}

# Conclusion

# Code Appendix 

## Import the data

```{r message = FALSE, warning = FALSE}
library(stringr)
library(readxl)
library(visdat)
library(dplyr)
library(car)
library(GGally)
library(rpart)
library(caret)
library(pROC)
library(rpart.plot) 
library(ggplot2)
library(knitr)
library(rsample)
library(vip)
```

```{r}
knee <- read_excel("Osteoporosis Knee X-ray/patient details.xlsx")
knee <- knee[1:(nrow(knee) - 3), ]
knee <- knee |> mutate(across(where(is.character), as.factor))
```

```{r}
knee |> select(`Maximum Walking distance (km)`) |> 
  table() |> hist(main = "Distribution of Maximum Walking distance",
                  xlab = "Maximum Walking distance(km)")
```

```{r}
knee |> filter(Gender == "female") |> 
  select(`Menopause Age`) |> 
  boxplot(main = "Distribution Of Menopause Age for Female",
          ylab = "Menopause Age",
          xlab = "Gender in Female")
```

```{r}
knee |> filter(Gender == "female") |> 
  select(`Number of Pregnancies`) |> 
  boxplot(main = "Distribution Of Number of Pregnancies for Female",
          ylab = "Number of Pregnancies",
          xlab = "Gender in Female")
```

## Missing Values

```{r}
colSums(is.na(knee))
```

```{r}
naniar::gg_miss_var(knee)
```

## Clean the data

#### Maximum Walking distance

* There is 1 missing value in `Maximum Walking distance (km)`. The distribution is right skewed. Impute it with the median.

```{r}
mwd_median <- median(knee$`Maximum Walking distance (km)`, na.rm = T)
knee <- knee |> mutate(
  MWD = ifelse(is.na(`Maximum Walking distance (km)`), mwd_median,
               `Maximum Walking distance (km)`)
) |> select(-`Maximum Walking distance (km)`)
```

```{r}
knee |> select(MWD) |> 
  table() |> hist(main = "Distribution of Maximum Walking distance(After Impute NA)",
                  xlab = "Maximum Walking distance(km)")
```

#### Menopause Age

* Menopause typically occurs naturally between the ages of 45 and 55, with the average age being 51. It's defined as the point when a woman has not had a menstrual period for 12 consecutive months. 

```{r}
knee$Menopause_Age <- as.numeric(knee$`Menopause Age`)
knee <- knee |> select(-`Menopause Age`)
```

* The Menopause Age is right skewed for female. Impute the missing value with its median for female only. For male would be not apply. 

```{r}
female_median <- median(knee$Menopause_Age[knee$Gender == "female"], na.rm = TRUE)

knee <- knee  |> 
  mutate(Menopause_Age = case_when(
    Gender == "female" & is.na(Menopause_Age) ~ female_median,
    Gender == "male" & is.na(Menopause_Age) ~ NA_real_,  # keep as NA
    TRUE ~ Menopause_Age
  ))

knee |> filter(Gender == "female") |> 
  select(Menopause_Age) |> 
  boxplot(main = "Distribution Of Menopause Age for Female(After Impute NA)",
          ylab = "Menopause Age",
          xlab = "Gender in Female")
```

#### Number of Pregnancies

* There is only one patient gender in male with number of pregnancies=4. Others are missing values.

```{r}
knee |> 
  filter(!is.na(`Number of Pregnancies`) & Gender == "male")
```

* Impute the gender male for number of pregnancies is 0.

```{r}
female_mean <- mean(knee$`Number of Pregnancies`[knee$Gender == "female"], 
                    na.rm = TRUE)

knee <- knee  |> 
  mutate(pregnancies = case_when(
    Gender == "female" & is.na(`Number of Pregnancies`) ~ female_mean,
    Gender == "male" & is.na(`Number of Pregnancies`) ~ 0,  # keep as NA
    TRUE ~ `Number of Pregnancies`
  )) |> 
  select(-`Number of Pregnancies`)

knee |> filter(Gender == "female") |> 
  select(pregnancies) |> 
  boxplot(main = "Distribution of Number of Pregnancies for Female
          (After Impute NA)",
          ylab = "Number of Pregnancies",
          xlab = "Female Patients")
```

#### There are some categoriacal variables with only one level and some missing values

* `Alcoholic` only has the observation of "no". This variable will be dropped since is not helpful to put into the logistic regression.

* `Dialysis` is extremely imbalanced. There are only 1 observation with the level of "yes". The rest are "no". It is not stable in estimates.

* `Site` is not important. The data set is all about the knee.

#### Other Variables

* `Occupation` with too many levels and most of the levels are only 1 observation. Need to be organized. Majority is house wife.


```{r}
occupation_corrections <- c(
  "h.wife" = "housewife"
)

knee <- knee |> 
  mutate(
     # lowercase and trim
    career_clean = tolower(trimws(Occupation)),
    
    # replace the names
    career_clean = str_replace_all(career_clean, occupation_corrections),
    
    # the missing value as "unknown"
    career_clean = ifelse(is.na(career_clean), "unknown", career_clean),
    
    # organize it more
    career = case_when(career_clean == "housewife" ~ "housewife",
      TRUE ~ "others"
    )
  ) |> select(-career_clean, -Occupation)
table(knee$career)
```

* `Daily Eating habits` same. Need to be organized. The main limits are Low/No Fat, Low Salt, Low/No Protein, Low Sugar, No Sour Food. Organize it as 2 levels Normal and Limited. The missing value as normal(there are 2).

```{r}
knee <- knee |> 
  mutate(
    eating_clean = tolower(trimws(`Daily Eating habits`)),
    eating_habit = ifelse(
      eating_clean == "normal", "normal", "limited"
    )
  ) |>
  select(-eating_clean, -`Daily Eating habits`)
table(knee$eating_habit)
```

* `Obesity` combine over weight and overweight.

```{r}
knee <- knee |> mutate(
  obesity = ifelse(Obesity == "overweight", "over weight", Obesity)
) |> select(-Obesity)
table(knee$obesity)
```

* Clean up `History of Fracture` into injuries in lower body, upper body, other, or no injury

```{r}
knee <- knee |> 
  mutate(
    injury_type = `History of Fracture`,
    # Clean up and categorize injuries into main parts
    injury_part = case_when(
      str_detect(injury_type, "leg") ~ "leg",
      str_detect(injury_type, "foot") ~ "foot",
      str_detect(injury_type, "arm") ~ "arm",
      str_detect(injury_type, "wrist") ~ "wrist",
      str_detect(injury_type, "shoulder") ~ "shoulder",
      str_detect(injury_type, "hip") ~ "hip",
      str_detect(injury_type, "no") ~ "no injury",
      str_detect(injury_type, "knee") ~ "knee",
      str_detect(injury_type, "head") ~ "head",
      str_detect(injury_type, "neck") ~ "neck",
      TRUE ~ "Other"
    ),
    
    # Categorizing into lower body, upper body, and fractures
    injury = case_when(
      injury_part %in% c("leg", "foot", "hip", "knee") ~ "Lower Body",
      injury_part %in% c("arm", "wrist", "shoulder", "head", "neck") ~ "Upper Body",
      injury_part == "Other" ~ "Other",
      injury_part == "no injury" ~ "no injury",
      TRUE ~ "Fractures"
    )
  ) |> select(-injury_type, -injury_part, -`History of Fracture`)
table(knee$injury)
```

* Clean `Medical History` into yes for having medical history and no for not having medical history

```{r}
knee <- knee |> mutate(
  medical_hist = ifelse(`Medical History` %in% c("no", "normal"), "no", "yes")
) |> select(-`Medical History`)
table(knee$medical_hist)
```

#### Rename the variables and filter out not interesting variables

```{r}
knee <- knee |> mutate(across(where(is.character), as.factor)) |> 
  select(-`Patient Id`, -Alcoholic, -Site, -S.No) |> 
  rename(BMI = `BMI:`,
         dialysis = `Dialysis:`,
         joint_pain = `Joint Pain:`)
```

```{r}
# Create a binary response with yes or no (1, 0)
knee_clean <- knee |> mutate(
  dummy_diagnosis = ifelse(Diagnosis == "normal", 0, 1),
  dummy_diagnosis = as.factor(dummy_diagnosis),
)
```

## Visualization

### Corelation

```{r message=FALSE, fig.width=15, fig.height=10}
ggpairs(
  knee |> select(Diagnosis, where(is.numeric), -Menopause_Age),
  aes(color = Diagnosis),
  upper = list(continuous = wrap("cor", size = 4)), 
  lower = list(continuous = wrap("points", alpha = 0.6)),
  diag = list(continuous = wrap("densityDiag", alpha = 0.5)),
  legend = 1
) + 
  scale_color_brewer(palette = "Set2") +
  theme_minimal()
```

### Diagnoses comparing with gender male excluding [menopause age, number of pregnancies] 

```{r}
knee_clean |> group_by(Diagnosis) |> 
  ggplot(aes(x = Diagnosis, fill = Gender)) +
  geom_bar(position = "dodge", col = "black") +
  labs(title = "Diagnosis Distribution among male 
       and female patients",
       y = "Frequency") + 
  theme_classic()
```

```{r}
knee_male <- knee_clean |>
  filter(Gender == "male") |>
  group_by(Diagnosis) |>
  select(-Menopause_Age) |>
    count(name = "Male Patients")
knee_male
knee_female <- knee_clean |>
  filter(Gender == "female") |>
  group_by(Diagnosis) |>
    count(name = "Female Patients")
knee_female
```

## Logistic Regression

```{r}
knee_model <- knee_clean |> 
  select(-Diagnosis, -Menopause_Age, -dialysis, 
         -`T-score Value`, -`Z-Score Value`, -obesity) |> na.omit()

full <- glm(dummy_diagnosis ~ ., data = knee_model, family = binomial)
summary(full)

null <- glm(dummy_diagnosis ~ 1, data = knee_model, family = binomial)
```

**AIC**

```{r}
step(full, trace = 0)

select_aic <- glm(dummy_diagnosis ~ Age + `Weight (KG)` + Diabetic + 
    BMI + pregnancies + career + medical_hist, family = binomial, 
    data = knee_model)

summary(select_aic)
```

**BIC**

```{r}
step(full, trace = 0, k = log(nrow(knee_model)))
```

```{r}
select_bic <- glm(dummy_diagnosis ~ Age + pregnancies, family = binomial, 
    data = knee_model)
summary(select_bic)
```

```{r}
AIC(null, full, select_bic, select_aic)
BIC(null, full, select_bic, select_aic)
```

## Cross Validation: check the logistic model

**BIC Model**

```{r message=FALSE}
set.seed(333)
n <- nrow(knee_model)
floor(0.7*n)

# split into training data and testing data
train <- sample(1:n, 166)

# fit the model with training data
glm_train <- glm(dummy_diagnosis ~ Age + pregnancies, family = binomial, 
    data = knee_model, subset = train) # chose the smallest bic model

# summary
summary(glm_train)

# test set
test <- knee_model[-train, ]

# prediction on test set
pred_prob <- predict(glm_train, newdata = test, type = "response")

# classify the prediction
length(pred_prob)

class_preds <- rep(0, 72)
class_preds[pred_prob > 0.5] <- 1

# confusion matrix
addmargins(table(prediction = class_preds, actual = test$dummy_diagnosis))

# accuracy
(9 + 57)/72 # 0.9166667

# sensitivity
57/61 # 0.9344262

# specificity
9/11 # 0.8181818

# ROC curve
roc_obj <- roc(test$dummy_diagnosis, pred_prob)
plot(1 - roc_obj$specificities, roc_obj$sensitivities, type = "l",
     xlab = "1 - Specificity", ylab = "Sensitivity")

abline(0, 1, lty=2)
points(x = 2/11, y = 57/61, col = "red", pch = 19)


# ROC Curve
roc_curve <- roc(test$dummy_diagnosis, pred_prob)
plot(roc_curve, main = "ROC Curve for BIC Model", col = "blue", lwd = 2)


# AUC
auc(roc_obj) # 0.9553
```
**AIC model**

```{r message=FALSE}
# fit the model with training data
glm_train <- glm(dummy_diagnosis ~ Age + `Weight (KG)` + Diabetic + 
    BMI + pregnancies + career + medical_hist, family = binomial, 
    data = knee_model)

# summary
summary(glm_train)

# test set
test <- knee_model[-train, ]

# prediction on test set
pred_prob <- predict(glm_train, newdata = test, type = "response")

# classify the prediction
class_preds <- rep(0, 72)
class_preds[pred_prob > 0.5] <- 1

# confusion matrix
addmargins(table(prediction = class_preds, actual = test$dummy_diagnosis))

# accuracy
(10 + 58)/72 # 0.9444444

# sensitivity
58/61 # 0.9508197

# specificity
10/11 # 0.9090909

# ROC curve
roc_obj <- roc(test$dummy_diagnosis, pred_prob)
plot(1 - roc_obj$specificities, roc_obj$sensitivities, type = "l",
     xlab = "1 - Specificity", ylab = "Sensitivity")
abline(0, 1, lty=2)
points(x = 1/11, y = 58/61, col = "red", pch = 19)

# ROC Curve
roc_curve <- roc(test$dummy_diagnosis, pred_prob)
plot(roc_curve, main = "ROC Curve for AIC Model", col = "blue", lwd = 2)


# AUC
auc(roc_obj) # 0.9434
```

## Desicion Tree

```{r}
# Split data into training and testing sets
set.seed(333)

data_split <- knee_model |> initial_split(prop = 0.7)
train_data <- data_split |> training()
test_data <- data_split |> testing()

# Fit the Decision Tree Model
tree_model <- rpart(dummy_diagnosis ~ ., data = train_data, method = "class")

# Predict on the test set
tree_pred <- predict(tree_model, test_data, type = "class")
tree_pred_prob <- predict(tree_model, test_data, type = "prob")

# Confusion Matrix
conf_matrix <- table(test_data$dummy_diagnosis, tree_pred)

addmargins(conf_matrix)

# Calculate Accuracy, Sensitivity, and Specificity

(4 + 59)/72 # 0.875
59/66 # 0.8939394
4/6 # 0.6666667

# ROC Curve
roc_curve <- roc(test_data$dummy_diagnosis, tree_pred_prob[,2])
plot(roc_curve, main = "ROC Curve for Decision Tree", col = "blue", lwd = 2)

# Calculate AUC (Area Under the Curve)
auc_value <- auc(roc_curve)
auc_value #  0.8979

# Variable Importance
var_imp <- tree_model$variable.importance
print(var_imp)

v_plot <- vip(tree_model) + geom_col(fill = "khaki", col = "black") + 
  theme_minimal() +
  labs(title = "Important Variables in Decision Tree Model")
v_plot

# Plot the Decision Tree
rpart.plot(tree_model, type = 3, main = "Decision Tree", digits = 1)
```

```{r}
knee_tree <- knee_clean |> 
  select(-dummy_diagnosis, -dialysis, 
         -`T-score Value`, -`Z-Score Value`) |> na.omit()
# Split data into training and testing sets
set.seed(632)

data_split1 <- knee_tree |> initial_split(prop = 0.7)
train_data1 <- data_split1 |> training()
test_data1 <- data_split1 |> testing()

# Fit the Decision Tree Model
tree_model1 <- rpart(Diagnosis ~ ., data = train_data1, method = "class")

# Predict on the test set
tree_pred1 <- predict(tree_model1, test_data1, type = "class")
tree_pred_prob1 <- predict(tree_model1, test_data1, type = "prob")

# Confusion Matrix
conf_matrix1 <- table(test_data1$Diagnosis, tree_pred1)

addmargins(conf_matrix1)

# ROC Curve
roc_curve1 <- roc(test_data1$Diagnosis, tree_pred_prob1[,2])
plot(roc_curve1, main = "ROC Curve for Decision Tree", col = "blue", lwd = 2)

# Calculate AUC (Area Under the Curve)
auc_value1 <- auc(roc_curve1)
auc_value1 # 0.7418

# Variable Importance
var_imp1 <- tree_model1$variable.importance
print(var_imp1)

v_plot1 <- vip(tree_model1) + geom_col(fill = "khaki", col = "black") + 
  theme_minimal() +
  labs(title = "Important Variables in Decision Tree Model")
v_plot1

# Plot the Decision Tree
rpart.plot(tree_model1, type = 3, main = "Decision Tree", digits = 1)
```

